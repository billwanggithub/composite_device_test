<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peripheral Control - ESP32-S3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .page-wrapper {
            max-width: 1400px;
            margin: 0 auto;
        }

        .navigation-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .nav-link {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        .status-indicator.disconnected {
            background: #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .peripheral-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .peripheral-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .peripheral-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.mode {
            background: #d1ecf1;
            color: #0c5460;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-top: 5px;
        }

        .button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: #95a5a6;
        }

        .button.secondary:hover {
            background: #7f8c8d;
        }

        .button.danger {
            background: #e74c3c;
        }

        .button.danger:hover {
            background: #c0392b;
        }

        .button.success {
            background: #2ecc71;
        }

        .button.success:hover {
            background: #27ae60;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #555;
        }

        .info-value {
            color: #667eea;
            font-weight: 600;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .value-display {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            margin-top: 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: #2ecc71;
        }

        input:checked + .switch-slider:before {
            transform: translateX(26px);
        }

        .key-indicator {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 3px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .key-indicator.pressed {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(0.95);
        }

        .keys-display {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="navigation-bar">
            <a href="/" class="nav-link">üè† Motor Control</a>
            <a href="/peripherals.html" class="nav-link" style="background: #764ba2;">‚öôÔ∏è Peripherals</a>
            <a href="/settings.html" class="nav-link">üîß Settings</a>
        </div>

        <header>
            <h1>üîå Peripheral Control Dashboard</h1>
            <p>ESP32-S3 Multi-Interface System</p>
            <span id="connectionStatus" class="status-indicator disconnected"></span>
        </header>

        <div class="container">
            <div id="alertContainer"></div>

            <div class="peripheral-grid">
                <!-- UART1 Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üì° UART1 Multiplexer</span>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Mode Selection</label>
                        <select id="uart1ModeSelect" class="control-input">
                            <option value="DISABLED">Disabled</option>
                            <option value="UART">UART Mode</option>
                            <option value="PWM">PWM/RPM Mode</option>
                        </select>
                    </div>

                    <div id="uart1UartControls" style="display: none;">
                        <div class="control-group">
                            <label class="control-label">Baud Rate</label>
                            <input type="number" id="uart1Baud" class="control-input" value="115200" min="2400" max="1500000">
                        </div>
                        <button class="button" onclick="applyUART1Mode()">Update Baud Rate</button>
                    </div>

                    <div id="uart1PwmControls" style="display: none;">
                        <div class="control-group">
                            <label class="control-label">PWM Frequency (Hz): <span id="uart1FreqDisplay">1000</span></label>
                            <input type="range" id="uart1Freq" class="slider" min="1" max="500000" value="1000" step="1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">PWM Duty (%): <span id="uart1DutyDisplay">50.0</span></label>
                            <input type="range" id="uart1Duty" class="slider" min="0" max="100" value="50" step="0.1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">
                                PWM Enable
                                <label class="switch" style="float: right;">
                                    <input type="checkbox" id="uart1PwmEnable">
                                    <span class="switch-slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="info-row">
                            <span class="info-label">RPM Frequency:</span>
                            <span id="uart1RpmFreq" class="info-value">0 Hz</span>
                        </div>
                        <button class="button" onclick="applyUART1PWM()">Apply PWM Settings</button>
                    </div>

                    <div id="uart1Status" style="margin-top: 15px; display: none;">
                        <div class="info-row">
                            <span class="info-label">TX Bytes:</span>
                            <span id="uart1TxBytes" class="info-value">0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">RX Bytes:</span>
                            <span id="uart1RxBytes" class="info-value">0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Errors:</span>
                            <span id="uart1Errors" class="info-value">0</span>
                        </div>
                    </div>
                </div>

                <!-- UART2 Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üì° UART2</span>
                        <span class="status-badge enabled">ACTIVE</span>
                    </div>

                    <div class="info-row">
                        <span class="info-label">Baud Rate:</span>
                        <span id="uart2Baud" class="info-value">115200</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">TX Bytes:</span>
                        <span id="uart2TxBytes" class="info-value">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">RX Bytes:</span>
                        <span id="uart2RxBytes" class="info-value">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Errors:</span>
                        <span id="uart2Errors" class="info-value">0</span>
                    </div>
                </div>

                <!-- Buzzer Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üîä Buzzer</span>
                        <span id="buzzerStatus" class="status-badge disabled">OFF</span>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Frequency (Hz): <span id="buzzerFreqDisplay">2000</span></label>
                        <input type="range" id="buzzerFreq" class="slider" min="10" max="20000" value="2000" step="10">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Duty (%): <span id="buzzerDutyDisplay">50.0</span></label>
                        <input type="range" id="buzzerDuty" class="slider" min="0" max="100" value="50" step="0.1">
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Enable
                            <label class="switch" style="float: right;">
                                <input type="checkbox" id="buzzerEnable" onchange="applyBuzzer()">
                                <span class="switch-slider"></span>
                            </label>
                        </label>
                    </div>

                    <button class="button" onclick="applyBuzzer()">Apply Settings</button>
                    <button class="button secondary" onclick="buzzerBeep()">Test Beep</button>
                </div>

                <!-- LED PWM Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üí° LED PWM</span>
                        <span id="ledStatus" class="status-badge disabled">OFF</span>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Frequency (Hz): <span id="ledFreqDisplay">1000</span></label>
                        <input type="range" id="ledFreq" class="slider" min="100" max="20000" value="1000" step="10">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Brightness (%): <span id="ledBrightnessDisplay">50.0</span></label>
                        <input type="range" id="ledBrightness" class="slider" min="0" max="100" value="50" step="0.1">
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Enable
                            <label class="switch" style="float: right;">
                                <input type="checkbox" id="ledEnable" onchange="applyLED()">
                                <span class="switch-slider"></span>
                            </label>
                        </label>
                    </div>

                    <button class="button" onclick="applyLED()">Apply Settings</button>
                </div>

                <!-- Relay Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üîå Relay</span>
                        <span id="relayStatus" class="status-badge disabled">OFF</span>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="button success" onclick="setRelay('on')">Turn ON</button>
                        <button class="button danger" onclick="setRelay('off')">Turn OFF</button>
                        <button class="button secondary" onclick="setRelay('toggle')">Toggle</button>
                    </div>
                </div>

                <!-- GPIO Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üîß GPIO Output</span>
                        <span id="gpioStatus" class="status-badge disabled">LOW</span>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="button success" onclick="setGPIO('high')">Set HIGH</button>
                        <button class="button danger" onclick="setGPIO('low')">Set LOW</button>
                        <button class="button secondary" onclick="setGPIO('toggle')">Toggle</button>
                    </div>
                </div>

                <!-- User Keys Card -->
                <div class="peripheral-card">
                    <div class="card-header">
                        <span class="card-title">üéÆ User Keys</span>
                        <span id="keysMode" class="status-badge mode">DUTY</span>
                    </div>

                    <div class="keys-display">
                        <div>
                            <div id="key1" class="key-indicator">KEY 1<br>‚Üë</div>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">Increase</div>
                        </div>
                        <div>
                            <div id="key2" class="key-indicator">KEY 2<br>‚Üì</div>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">Decrease</div>
                        </div>
                        <div>
                            <div id="key3" class="key-indicator">KEY 3<br>‚èé</div>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">Enter</div>
                        </div>
                    </div>

                    <div class="info-row">
                        <span class="info-label">Control Mode:</span>
                        <span id="keysControlMode" class="info-value">DUTY</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Control Enabled:</span>
                        <span id="keysControlEnabled" class="info-value">Yes</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Duty Step:</span>
                        <span id="keysDutyStep" class="info-value">1.0%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Freq Step:</span>
                        <span id="keysFreqStep" class="info-value">100 Hz</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval = null;
        let userChangingMode = false;  // Flag to prevent auto-sync during user interaction

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default UART1 mode to PWM (matches device startup default)
            document.getElementById('uart1ModeSelect').value = 'PWM';
            updateUART1ModeDisplay('PWM');

            initializeControls();
            fetchAllStatus();
            startAutoUpdate();
        });

        function initializeControls() {
            // UART1 sliders
            document.getElementById('uart1Freq').addEventListener('input', function() {
                document.getElementById('uart1FreqDisplay').textContent = this.value;
            });
            document.getElementById('uart1Duty').addEventListener('input', function() {
                document.getElementById('uart1DutyDisplay').textContent = parseFloat(this.value).toFixed(1);
            });

            // Buzzer sliders
            document.getElementById('buzzerFreq').addEventListener('input', function() {
                document.getElementById('buzzerFreqDisplay').textContent = this.value;
            });
            document.getElementById('buzzerDuty').addEventListener('input', function() {
                document.getElementById('buzzerDutyDisplay').textContent = parseFloat(this.value).toFixed(1);
            });

            // LED sliders
            document.getElementById('ledFreq').addEventListener('input', function() {
                document.getElementById('ledFreqDisplay').textContent = this.value;
            });
            document.getElementById('ledBrightness').addEventListener('input', function() {
                document.getElementById('ledBrightnessDisplay').textContent = parseFloat(this.value).toFixed(1);
            });

            // UART1 mode selector - apply mode change immediately
            document.getElementById('uart1ModeSelect').addEventListener('change', function() {
                const selectedMode = this.value;
                userChangingMode = true;  // Block auto-sync during user interaction
                updateUART1ModeDisplay(selectedMode);

                // Immediately apply the mode change via API
                const params = new URLSearchParams();
                params.append('mode', selectedMode);
                if (selectedMode === 'UART') {
                    params.append('baud', document.getElementById('uart1Baud').value);
                }

                fetch('/api/uart1/mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                })
                .then(response => response.json())
                .then(data => {
                    userChangingMode = false;  // Re-enable auto-sync after change completes
                    if (data.success) {
                        showAlert('UART1 mode changed to ' + selectedMode, 'success');
                    } else {
                        showAlert('Error: ' + (data.error || 'Mode change failed'), 'error');
                    }
                })
                .catch(error => {
                    userChangingMode = false;  // Re-enable auto-sync on error
                    showAlert('Network error: ' + error.message, 'error');
                });
            });
        }

        function updateUART1ModeDisplay(mode) {
            document.getElementById('uart1UartControls').style.display = mode === 'UART' ? 'block' : 'none';
            document.getElementById('uart1PwmControls').style.display = mode === 'PWM' ? 'block' : 'none';
            document.getElementById('uart1Status').style.display = mode === 'UART' ? 'block' : 'none';
        }

        function startAutoUpdate() {
            updateInterval = setInterval(fetchAllStatus, 1000);
        }

        function fetchAllStatus() {
            fetch('/api/peripherals')
                .then(response => response.json())
                .then(data => {
                    updateConnectionStatus(true);
                    updatePeripheralStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    updateConnectionStatus(false);
                });
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = 'status-indicator ' + (connected ? 'connected' : 'disconnected');
        }

        function updatePeripheralStatus(data) {
            // UART1
            if (data.uart1) {
                // Sync dropdown with device status (unless user is actively changing it)
                if (!userChangingMode) {
                    const modeSelect = document.getElementById('uart1ModeSelect');
                    let modeValue = 'DISABLED';
                    if (data.uart1.mode === 'PWM_RPM' || data.uart1.mode === 'PWM/RPM') {
                        modeValue = 'PWM';
                    } else if (data.uart1.mode === 'UART') {
                        modeValue = 'UART';
                    } else if (data.uart1.mode === 'DISABLED') {
                        modeValue = 'DISABLED';
                    }

                    // Only update if value has changed to avoid unnecessary control updates
                    if (modeSelect.value !== modeValue) {
                        modeSelect.value = modeValue;
                        updateUART1ModeDisplay(modeValue);
                    }
                }

                // Update PWM/RPM specific data
                if (data.uart1.mode === 'PWM_RPM' && data.uart1.rpm_freq !== undefined) {
                    document.getElementById('uart1RpmFreq').textContent = data.uart1.rpm_freq.toFixed(2) + ' Hz';
                }
                if (data.uart1.pwm_freq !== undefined) {
                    document.getElementById('uart1Freq').value = data.uart1.pwm_freq;
                    document.getElementById('uart1FreqDisplay').textContent = data.uart1.pwm_freq;
                }
                if (data.uart1.pwm_duty !== undefined) {
                    document.getElementById('uart1Duty').value = data.uart1.pwm_duty;
                    document.getElementById('uart1DutyDisplay').textContent = data.uart1.pwm_duty.toFixed(1);
                }
                if (data.uart1.pwm_enabled !== undefined) {
                    document.getElementById('uart1PwmEnable').checked = data.uart1.pwm_enabled;
                }

                // Update UART statistics
                if (data.uart1.tx_bytes !== undefined) {
                    document.getElementById('uart1TxBytes').textContent = data.uart1.tx_bytes;
                    document.getElementById('uart1RxBytes').textContent = data.uart1.rx_bytes;
                    document.getElementById('uart1Errors').textContent = data.uart1.errors;
                }
            }

            // UART2
            if (data.uart2) {
                document.getElementById('uart2Baud').textContent = data.uart2.baud || '0';
                document.getElementById('uart2TxBytes').textContent = data.uart2.tx_bytes || '0';
                document.getElementById('uart2RxBytes').textContent = data.uart2.rx_bytes || '0';
                document.getElementById('uart2Errors').textContent = data.uart2.errors || '0';
            }

            // Buzzer
            if (data.buzzer) {
                updateStatusBadge('buzzerStatus', data.buzzer.enabled);
            }

            // LED
            if (data.led) {
                updateStatusBadge('ledStatus', data.led.enabled);
            }

            // Relay
            if (data.relay) {
                const badge = document.getElementById('relayStatus');
                badge.textContent = data.relay.state ? 'ON' : 'OFF';
                badge.className = 'status-badge ' + (data.relay.state ? 'enabled' : 'disabled');
            }

            // GPIO
            if (data.gpio) {
                const badge = document.getElementById('gpioStatus');
                badge.textContent = data.gpio.state ? 'HIGH' : 'LOW';
                badge.className = 'status-badge ' + (data.gpio.state ? 'enabled' : 'disabled');
            }

            // Keys
            if (data.keys) {
                updateKeyIndicator('key1', data.keys.key1);
                updateKeyIndicator('key2', data.keys.key2);
                updateKeyIndicator('key3', data.keys.key3);
                document.getElementById('keysControlMode').textContent = data.keys.mode || 'DUTY';
                document.getElementById('keysMode').textContent = data.keys.mode || 'DUTY';
                document.getElementById('keysControlEnabled').textContent = data.keys.control_enabled ? 'Yes' : 'No';
                if (data.keys.duty_step !== undefined) {
                    document.getElementById('keysDutyStep').textContent = data.keys.duty_step.toFixed(1) + '%';
                }
                if (data.keys.freq_step !== undefined) {
                    document.getElementById('keysFreqStep').textContent = data.keys.freq_step + ' Hz';
                }
            }
        }

        function updateStatusBadge(elementId, enabled) {
            const badge = document.getElementById(elementId);
            badge.textContent = enabled ? 'ON' : 'OFF';
            badge.className = 'status-badge ' + (enabled ? 'enabled' : 'disabled');
        }

        function updateKeyIndicator(elementId, pressed) {
            const indicator = document.getElementById(elementId);
            if (pressed) {
                indicator.classList.add('pressed');
            } else {
                indicator.classList.remove('pressed');
            }
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert ' + type;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // API Functions
        function applyUART1Mode() {
            const mode = document.getElementById('uart1ModeSelect').value;
            const baud = document.getElementById('uart1Baud').value;

            const params = new URLSearchParams();
            params.append('mode', mode);
            if (mode === 'UART') {
                params.append('baud', baud);
            }

            fetch('/api/uart1/mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('UART1 mode changed successfully', 'success');
                    fetchAllStatus();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'error');
            });
        }

        function applyUART1PWM() {
            const freq = document.getElementById('uart1Freq').value;
            const duty = document.getElementById('uart1Duty').value;
            const enabled = document.getElementById('uart1PwmEnable').checked;

            const params = new URLSearchParams();
            params.append('frequency', freq);
            params.append('duty', duty);
            params.append('enabled', enabled);

            fetch('/api/uart1/pwm', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('UART1 PWM updated successfully', 'success');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }

        function applyBuzzer() {
            const freq = document.getElementById('buzzerFreq').value;
            const duty = document.getElementById('buzzerDuty').value;
            const enabled = document.getElementById('buzzerEnable').checked;

            const params = new URLSearchParams();
            params.append('frequency', freq);
            params.append('duty', duty);
            params.append('enabled', enabled);

            fetch('/api/buzzer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Buzzer settings updated', 'success');
                    fetchAllStatus();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }

        function buzzerBeep() {
            const params = new URLSearchParams();
            params.append('beep', 'true');
            params.append('beep_freq', '2000');
            params.append('beep_duration', '200');

            fetch('/api/buzzer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Beep!', 'info');
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }

        function applyLED() {
            const freq = document.getElementById('ledFreq').value;
            const brightness = document.getElementById('ledBrightness').value;
            const enabled = document.getElementById('ledEnable').checked;

            const params = new URLSearchParams();
            params.append('frequency', freq);
            params.append('brightness', brightness);
            params.append('enabled', enabled);

            fetch('/api/led', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('LED settings updated', 'success');
                    fetchAllStatus();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }

        function setRelay(state) {
            const params = new URLSearchParams();
            params.append('state', state);

            fetch('/api/relay', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Relay ' + state, 'success');
                    fetchAllStatus();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }

        function setGPIO(state) {
            const params = new URLSearchParams();
            params.append('state', state);

            fetch('/api/gpio', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('GPIO set to ' + state, 'success');
                    fetchAllStatus();
                } else {
                    showAlert('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => showAlert('Network error: ' + error.message, 'error'));
        }
    </script>
</body>
</html>
