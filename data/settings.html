<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統設置 - ESP32 Motor Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
        }

        .language-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            text-align: right;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }

        .language-bar label {
            font-weight: bold;
            margin-right: 10px;
            color: #2c3e50;
            font-size: 14px;
        }

        .language-bar select {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 14px;
            min-width: 130px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .navigation-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            text-align: center;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-link.active {
            background: #764ba2;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
            font-weight: 300;
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .form-group .help-text {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .status-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-info .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-info .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .status-info .info-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .status-info .info-value {
            color: #7f8c8d;
        }

        /* Emergency Stop Error Banner */
        .error-banner {
            background: rgba(231, 76, 60, 0.15);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 15px 20px;
            margin: 20px;
            display: none;
            animation: pulse 2s ease-in-out infinite;
        }

        .error-banner.show {
            display: block;
        }

        .error-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .error-banner-text {
            color: #e74c3c;
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }

        .error-banner-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-warning {
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- 導航列 -->
        <div class="navigation-bar">
            <div class="nav-links">
                <a href="/index.html" class="nav-link">
                    <span class="lang-zh-CN">主控制台</span>
                    <span class="lang-en">Dashboard</span>
                </a>
                <a href="/settings.html" class="nav-link active">
                    <span class="lang-zh-CN">系統設置</span>
                    <span class="lang-en">Settings</span>
                </a>
            </div>
        </div>

        <!-- Emergency Stop Error Banner -->
        <div class="error-banner" id="errorBanner">
            <div class="error-banner-content">
                <div>
                    <span class="error-banner-icon">⛔</span>
                    <span class="error-banner-text" id="errorBannerText">SAFETY ALERT: Emergency stop activated!</span>
                </div>
                <button class="btn-warning" onclick="clearError()">
                    <span class="lang-zh-CN">清除錯誤 / 恢復</span>
                    <span class="lang-en">Clear Error / Resume</span>
                </button>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="container">
            <div class="header">
                <h1 class="title">
                    <span class="lang-zh-CN">系統設置</span>
                    <span class="lang-en">System Settings</span>
                </h1>
                <p class="subtitle">
                    <span class="lang-zh-CN">配置和管理所有系統參數</span>
                    <span class="lang-en">Configure and manage all system parameters</span>
                </p>
            </div>

            <!-- 狀態訊息 -->
            <div id="statusMessage" class="status-message"></div>

            <!-- 系統狀態資訊 -->
            <div class="status-info">
                <h3>
                    <span class="lang-zh-CN">系統狀態</span>
                    <span class="lang-en">System Status</span>
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">固件版本</span>
                            <span class="lang-en">Firmware Version</span>
                        </span>
                        <span class="info-value" id="firmwareVersion">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">WiFi IP</span>
                        <span class="info-value" id="wifiIP">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">系統運行時間</span>
                            <span class="lang-en">Uptime</span>
                        </span>
                        <span class="info-value" id="uptime">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">可用記憶體</span>
                            <span class="lang-en">Free Heap</span>
                        </span>
                        <span class="info-value" id="freeHeap">-</span>
                    </div>
                </div>
            </div>

            <!-- UI 設置 -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">界面設置</span>
                    <span class="lang-en">UI Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">標題</span>
                        <span class="lang-en">Title</span>
                    </label>
                    <input type="text" id="title" maxlength="50">
                    <span class="help-text">
                        <span class="lang-zh-CN">顯示在主頁面的標題</span>
                        <span class="lang-en">Title displayed on main page</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">副標題</span>
                        <span class="lang-en">Subtitle</span>
                    </label>
                    <input type="text" id="subtitle" maxlength="50">
                    <span class="help-text">
                        <span class="lang-zh-CN">顯示在標題下方的副標題</span>
                        <span class="lang-en">Subtitle displayed below title</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">BLE 裝置名稱</span>
                        <span class="lang-en">BLE Device Name</span>
                    </label>
                    <input type="text" id="bleDeviceName" maxlength="30">
                    <span class="help-text">
                        <span class="lang-zh-CN">藍牙裝置的名稱（需重啟生效）</span>
                        <span class="lang-en">Bluetooth device name (requires restart)</span>
                    </span>
                </div>
            </div>

            <!-- PWM 控制設置 -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">PWM 控制設置</span>
                    <span class="lang-en">PWM Control Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">最大頻率 (Hz)</span>
                        <span class="lang-en">Maximum Frequency (Hz)</span>
                    </label>
                    <input type="number" id="maxFrequency" min="1000" max="500000">
                    <span class="help-text">
                        <span class="lang-zh-CN">PWM 頻率的上限（1,000 - 500,000 Hz）</span>
                        <span class="lang-en">Upper limit for PWM frequency (1,000 - 500,000 Hz)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">最大安全轉速 (RPM)</span>
                        <span class="lang-en">Max Safe RPM</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="maxSafeRPM" min="1000" max="1000000" style="flex: 1;">
                        <input type="checkbox" id="maxSafeRPMEnabled" style="width: 20px; height: 20px; cursor: pointer;" title="Enable/Disable protection">
                    </div>
                    <span class="help-text">
                        <span class="lang-zh-CN">超速保護閾值，超過此轉速將觸發緊急停止（勾選以啟用保護）</span>
                        <span class="lang-en">Overspeed protection threshold, emergency stop triggered if exceeded (check to enable)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">占空比步進 (%)</span>
                        <span class="lang-en">Duty Cycle Step (%)</span>
                    </label>
                    <input type="number" id="dutyStepSize" min="0.1" max="100" step="0.1">
                    <span class="help-text">
                        <span class="lang-zh-CN">調整占空比時的步進值</span>
                        <span class="lang-en">Step size for duty cycle adjustment</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">頻率步進 (Hz)</span>
                        <span class="lang-en">Frequency Step (Hz)</span>
                    </label>
                    <input type="number" id="freqStepSize" min="1" max="100000">
                    <span class="help-text">
                        <span class="lang-zh-CN">調整頻率時的步進值</span>
                        <span class="lang-en">Step size for frequency adjustment</span>
                    </span>
                </div>
            </div>

            <!-- RPM 測量設置 -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">RPM 測量設置</span>
                    <span class="lang-en">RPM Measurement Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">極對數</span>
                        <span class="lang-en">Pole Pairs</span>
                    </label>
                    <input type="number" id="polePairs" min="1" max="12">
                    <span class="help-text">
                        <span class="lang-zh-CN">電機的極對數（1-12）</span>
                        <span class="lang-en">Motor pole pairs (1-12)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">圖表更新率 (毫秒)</span>
                        <span class="lang-en">Chart Update Rate (ms)</span>
                    </label>
                    <select id="rpmUpdateRate">
                        <option value="20">50 Hz (20ms)</option>
                        <option value="33">30 Hz (33ms)</option>
                        <option value="50">20 Hz (50ms)</option>
                        <option value="100">10 Hz (100ms)</option>
                        <option value="200">5 Hz (200ms)</option>
                    </select>
                    <span class="help-text">
                        <span class="lang-zh-CN">RPM 圖表數據更新的頻率</span>
                        <span class="lang-en">Frequency of RPM chart data updates</span>
                    </span>
                </div>
            </div>

            <!-- LED 設置 -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">LED 狀態指示器</span>
                    <span class="lang-en">LED Status Indicator</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">LED 亮度 (0-255)</span>
                        <span class="lang-en">LED Brightness (0-255)</span>
                    </label>
                    <input type="range" id="ledBrightness" min="0" max="255" step="1">
                    <span class="help-text">
                        <span class="lang-zh-CN">當前值：</span>
                        <span class="lang-en">Current value: </span>
                        <span id="ledBrightnessValue">25</span>
                    </span>
                </div>
            </div>

            <!-- WiFi 設置 -->
            <div class="settings-section">
                <h2 class="section-title">WiFi
                    <span class="lang-zh-CN">設置</span>
                    <span class="lang-en">Settings</span>
                </h2>
                <div class="form-group">
                    <label>WiFi SSID</label>
                    <input type="text" id="wifiSSID" maxlength="32">
                    <span class="help-text">
                        <span class="lang-zh-CN">WiFi 網路名稱</span>
                        <span class="lang-en">WiFi network name</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>WiFi
                        <span class="lang-zh-CN">密碼</span>
                        <span class="lang-en">Password</span>
                    </label>
                    <input type="password" id="wifiPassword" maxlength="64">
                    <span class="help-text">
                        <span class="lang-zh-CN">WiFi 密碼（8-64 個字元）</span>
                        <span class="lang-en">WiFi password (8-64 characters)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="apModeEnabled" style="margin-right: 10px;">
                        <span class="lang-zh-CN">啟用 AP 熱點模式</span>
                        <span class="lang-en">Enable AP (Hotspot) Mode</span>
                    </label>
                    <span class="help-text">
                        <span class="lang-zh-CN">開機時自動啟動 WiFi 熱點 (SSID: ESP32_Motor_Control, IP: 192.168.4.1)</span>
                        <span class="lang-en">Auto-start WiFi hotspot on boot (SSID: ESP32_Motor_Control, IP: 192.168.4.1)</span>
                    </span>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="button-group">
                <button class="btn btn-success" onclick="loadSettings()">
                    <span class="lang-zh-CN">載入設置</span>
                    <span class="lang-en">Load Settings</span>
                </button>
                <button class="btn" onclick="saveToDevice()">
                    <span class="lang-zh-CN">應用設置</span>
                    <span class="lang-en">Apply Settings</span>
                </button>
                <button class="btn btn-secondary" onclick="saveToEEPROM()">
                    <span class="lang-zh-CN">保存到 EEPROM</span>
                    <span class="lang-en">Save to EEPROM</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'en';
        let isEmergencyStopActive = false; // Track emergency stop status

        // 初始化
        window.addEventListener('DOMContentLoaded', async function() {
            // 從後端 API 載入語言設定（只讀取，不提供切換）
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                if (data.language) {
                    currentLanguage = data.language;
                    console.log('✅ Settings 頁面從 API 載入語言:', currentLanguage);
                }
            } catch (error) {
                console.error('❌ 無法從 API 載入語言設定:', error);
                // 降級到 localStorage
                const savedLanguage = localStorage.getItem('language') || 'en';
                currentLanguage = savedLanguage;
                console.log('⚠️ Settings 頁面從 localStorage 載入語言:', currentLanguage);
            }

            updateLanguageDisplay();

            // 載入設置
            loadSettings();

            // 定期更新設置（每 5 秒輪詢，確保與控制台命令同步）
            setInterval(updateSettingsQuietly, 5000);

            // 載入系統狀態
            updateSystemStatus();
            setInterval(updateSystemStatus, 2000);

            // LED 亮度滑桿事件
            document.getElementById('ledBrightness').addEventListener('input', function() {
                document.getElementById('ledBrightnessValue').textContent = this.value;
            });
        });

        // 跨頁面語言同步 - 監聽主頁面的語言變更
        window.addEventListener('storage', function(e) {
            if (e.key === 'language' && e.newValue !== null) {
                const newLang = e.newValue;
                if (newLang !== currentLanguage) {
                    console.log('✅ 語言已從主頁面變更為:', newLang);
                    currentLanguage = newLang;
                    updateLanguageDisplay();
                }
            }
        });

        // 更新語言顯示
        function updateLanguageDisplay() {
            // 隱藏所有語言元素
            document.querySelectorAll('.lang-en, .lang-zh-CN').forEach(el => {
                el.style.display = 'none';
            });
            // 顯示當前語言的元素
            document.querySelectorAll('.lang-' + currentLanguage).forEach(el => {
                el.style.display = 'inline';
            });
            console.log('語言顯示已更新為:', currentLanguage);
        }

        // 載入設置
        async function loadSettings() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                document.getElementById('title').value = data.title || '';
                document.getElementById('subtitle').value = data.subtitle || '';
                document.getElementById('bleDeviceName').value = data.bleDeviceName || '';
                document.getElementById('dutyStepSize').value = data.dutyStepSize || 1.0;
                document.getElementById('freqStepSize').value = data.freqStepSize || 10;
                document.getElementById('maxFrequency').value = data.maxFrequency || 100000;
                document.getElementById('maxSafeRPM').value = data.maxSafeRPM || 500000;
                document.getElementById('maxSafeRPMEnabled').checked = (data.maxSafeRPMEnabled === true);
                document.getElementById('polePairs').value = data.polePairs || 2;
                document.getElementById('rpmUpdateRate').value = data.rpmUpdateRate || 100;
                document.getElementById('ledBrightness').value = data.ledBrightness || 25;
                document.getElementById('ledBrightnessValue').textContent = data.ledBrightness || 25;
                document.getElementById('wifiSSID').value = data.wifiSSID || '';
                document.getElementById('wifiPassword').value = data.wifiPassword || '';

                // 載入 AP 模式設定
                const apResponse = await fetch('/api/ap-mode');
                const apData = await apResponse.json();
                if (apData.success) {
                    document.getElementById('apModeEnabled').checked = apData.enabled || false;
                }

                showMessage('設置載入成功 / Settings loaded successfully', 'success');
            } catch (error) {
                showMessage('載入設置失敗 / Failed to load settings: ' + error.message, 'error');
            }
        }

        // 靜默更新設置（用於定期輪詢，不顯示成功消息，不覆蓋正在編輯的欄位）
        async function updateSettingsQuietly() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                // 只更新沒有焦點的欄位（用戶不在編輯中）
                const updateIfNotFocused = (id, value) => {
                    const element = document.getElementById(id);
                    if (element && document.activeElement !== element) {
                        element.value = value || '';
                    }
                };

                updateIfNotFocused('title', data.title);
                updateIfNotFocused('subtitle', data.subtitle);
                updateIfNotFocused('bleDeviceName', data.bleDeviceName);
                updateIfNotFocused('dutyStepSize', data.dutyStepSize || 1.0);
                updateIfNotFocused('freqStepSize', data.freqStepSize || 10);
                updateIfNotFocused('maxFrequency', data.maxFrequency || 100000);
                updateIfNotFocused('maxSafeRPM', data.maxSafeRPM || 500000);
                updateIfNotFocused('polePairs', data.polePairs || 2);
                updateIfNotFocused('rpmUpdateRate', data.rpmUpdateRate || 100);
                updateIfNotFocused('wifiSSID', data.wifiSSID);
                updateIfNotFocused('wifiPassword', data.wifiPassword);

                // LED brightness 特殊處理（同時更新滑桿和顯示值）
                const ledBrightnessEl = document.getElementById('ledBrightness');
                if (ledBrightnessEl && document.activeElement !== ledBrightnessEl) {
                    const brightness = data.ledBrightness || 25;
                    ledBrightnessEl.value = brightness;
                    document.getElementById('ledBrightnessValue').textContent = brightness;
                }

                // 更新 checkboxes（checkbox 不需要檢查焦點）
                if (data.maxSafeRPMEnabled !== undefined) {
                    document.getElementById('maxSafeRPMEnabled').checked = data.maxSafeRPMEnabled;
                }

                const apResponse = await fetch('/api/ap-mode');
                const apData = await apResponse.json();
                if (apData.success) {
                    document.getElementById('apModeEnabled').checked = apData.enabled || false;
                }
            } catch (error) {
                // 靜默失敗，不顯示錯誤消息（避免干擾用戶）
                console.error('Failed to update settings quietly:', error);
            }
        }

        // 應用設置到裝置
        async function saveToDevice() {
            try {
                const settings = {
                    title: document.getElementById('title').value,
                    subtitle: document.getElementById('subtitle').value,
                    bleDeviceName: document.getElementById('bleDeviceName').value,
                    dutyStepSize: parseFloat(document.getElementById('dutyStepSize').value),
                    freqStepSize: parseInt(document.getElementById('freqStepSize').value),
                    language: currentLanguage,
                    maxFrequency: parseInt(document.getElementById('maxFrequency').value),
                    maxSafeRPM: parseInt(document.getElementById('maxSafeRPM').value),
                    maxSafeRPMEnabled: document.getElementById('maxSafeRPMEnabled').checked,
                    polePairs: parseInt(document.getElementById('polePairs').value),
                    rpmUpdateRate: parseInt(document.getElementById('rpmUpdateRate').value),
                    ledBrightness: parseInt(document.getElementById('ledBrightness').value),
                    wifiSSID: document.getElementById('wifiSSID').value
                };

                const password = document.getElementById('wifiPassword').value;
                // 只在用戶實際修改密碼時才發送（不發送占位符 "********"）
                if (password && password.length >= 8 && password !== '********') {
                    settings.wifiPassword = password;
                }

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    // 保存 AP 模式設定
                    const apEnabled = document.getElementById('apModeEnabled').checked;
                    const apResponse = await fetch('/api/ap-mode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'enabled=' + apEnabled
                    });
                    const apData = await apResponse.json();

                    if (apData.success) {
                        showMessage('設置已應用 / Settings applied successfully', 'success');
                    } else {
                        showMessage('設置已應用但 AP 模式設定失敗 / Settings applied but AP mode failed', 'warning');
                    }

                    // 通知其他頁面更新
                    localStorage.setItem('settingsUpdated', Date.now().toString());
                } else {
                    showMessage('應用設置失敗 / Failed to apply settings', 'error');
                }
            } catch (error) {
                showMessage('應用設置失敗 / Failed to apply settings: ' + error.message, 'error');
            }
        }

        // 保存到 EEPROM
        async function saveToEEPROM() {
            try {
                // 先應用設置
                await saveToDevice();

                // 然後保存到 EEPROM
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('設置已保存到 EEPROM / Settings saved to EEPROM successfully', 'success');
                } else {
                    showMessage('保存到 EEPROM 失敗 / Failed to save to EEPROM', 'error');
                }
            } catch (error) {
                showMessage('保存到 EEPROM 失敗 / Failed to save to EEPROM: ' + error.message, 'error');
            }
        }

        // 更新系統狀態
        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                document.getElementById('firmwareVersion').textContent = data.firmwareVersion || '-';
                document.getElementById('wifiIP').textContent = data.wifiIP || '-';
                document.getElementById('uptime').textContent = data.uptime || '-';
                document.getElementById('freeHeap').textContent = (data.freeHeap ? (data.freeHeap / 1024).toFixed(1) + ' KB' : '-');

                // Handle emergency stop status
                const errorBanner = document.getElementById('errorBanner');
                const errorBannerText = document.getElementById('errorBannerText');
                if (data.emergencyStop !== undefined) {
                    const wasEmergencyStopped = isEmergencyStopActive;
                    isEmergencyStopActive = data.emergencyStop;  // Update global state

                    if (data.emergencyStop) {
                        // Update error message with RPM values (use trigger RPM, not current RPM)
                        const triggerRPM = data.emergencyStopTriggerRPM ? data.emergencyStopTriggerRPM.toFixed(1) : '---';
                        const maxRPM = data.maxSafeRPM || '---';
                        const message = currentLanguage === 'zh-CN'
                            ? `⚠️ 安全警報：緊急停止已激活！觸發轉速：${triggerRPM} RPM / 最大安全轉速：${maxRPM} RPM`
                            : `⚠️ SAFETY ALERT: Emergency stop activated! Trigger RPM: ${triggerRPM} / Max Safe RPM: ${maxRPM}`;
                        errorBannerText.textContent = message;
                        errorBanner.classList.add('show');

                        // Show popup notification when emergency stop FIRST activates (transition from false to true)
                        if (!wasEmergencyStopped) {
                            const popupMessage = currentLanguage === 'zh-CN'
                                ? `⛔ 緊急停止激活！\n\n觸發轉速：${triggerRPM} RPM\n最大安全轉速：${maxRPM} RPM\n\n電機已停止，請檢查並清除錯誤。`
                                : `⛔ EMERGENCY STOP ACTIVATED!\n\nTrigger RPM: ${triggerRPM}\nMax Safe RPM: ${maxRPM}\n\nMotor stopped. Please check and clear error.`;
                            alert(popupMessage);
                        }
                    } else {
                        errorBanner.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Failed to update system status:', error);
            }
        }

        // Clear emergency stop error
        async function clearError() {
            const confirmMessage = currentLanguage === 'zh-CN'
                ? '清除緊急停止並恢復正常操作？'
                : 'Clear emergency stop and resume normal operation?';

            if (confirm(confirmMessage)) {
                try {
                    const response = await fetch('/api/motor/clear-error', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            const successMessage = currentLanguage === 'zh-CN'
                                ? '錯誤已清除 - 系統已恢復'
                                : 'Emergency stop cleared - System resumed';
                            showMessage(successMessage, 'success');
                            // Force immediate status update
                            updateSystemStatus();
                        } else {
                            showMessage('Failed to clear error', 'error');
                        }
                    } else {
                        showMessage('Connection error', 'error');
                    }
                } catch (error) {
                    console.error('Error clearing emergency stop:', error);
                    showMessage('Connection error', 'error');
                }
            }
        }

        // 顯示訊息
        function showMessage(message, type) {
            const msgElement = document.getElementById('statusMessage');
            msgElement.textContent = message;
            msgElement.className = 'status-message ' + type;
            msgElement.style.display = 'block';

            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
